package zm.unza.counseling.jobs;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import zm.unza.counseling.service.AcademicPerformanceService;
import zm.unza.counseling.service.NotificationService;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;

@Slf4j
@Component
@RequiredArgsConstructor
public class ReportGenerationJob implements Job {

    @Value("${app.report.directory:/reports}")
    private String reportDirectory;

    private final AcademicPerformanceService academicPerformanceService;
    private final NotificationService notificationService;
    private final DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

    @Override
    public void execute(JobExecutionContext context) {
        log.info("Starting monthly report generation job at {}", LocalDateTime.now());
        
        try {
            LocalDate reportMonth = LocalDate.now().minusMonths(1);
            String reportFileName = String.format("monthly-performance-report-%s.csv", 
                reportMonth.format(dateFormatter));
            Path reportPath = Paths.get(reportDirectory, reportFileName);
            
            // Create reports directory if it doesn't exist
            Files.createDirectories(Paths.get(reportDirectory));
            
            // Generate academic performance report
            Map<String, Object> reportData = academicPerformanceService.generateMonthlyReport(reportMonth);
            
            // Here you would typically generate CSV/Excel/PDF reports
            // This is a simplified example - in production you'd use proper reporting libraries
            
            log.info("Report generated successfully: {}", reportPath);
            
            // Notify administrators about report completion
            notificationService.sendSystemNotification(
                "admin",
                "Monthly Report Generated",
                String.format("Monthly performance report for %s has been generated successfully.", 
                    reportMonth.format(dateFormatter)),
                "LOW"
            );
            
            log.info("Report generation job completed successfully at {}", LocalDateTime.now());
        } catch (IOException e) {
            log.error("Error creating report directory or file", e);
        } catch (Exception e) {
            log.error("Error in report generation job", e);
        }
    }
}